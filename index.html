<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>J√≠deln√≠ den√≠k</title>

  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0b1220"/>

  <style>
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#0b1220;color:#e8eefc}
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .card{background:#121a2c;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:14px}
    h1{margin:0 0 10px;font-size:22px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row > *{flex:0 0 auto}
    button, input, select, textarea{
      font:inherit;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:#0f1729;color:#e8eefc;padding:10px 12px;outline:none
    }
    button{cursor:pointer}
    button.primary{background:#1a2750;border-color:rgba(255,255,255,.16)}
    button.good{background:#113a22}
    button.warn{background:#3a2811}
    button.bad{background:#3a1111}
    .hint{color:#9fb0d6;font-size:13px}
    .spacer{height:10px}

    table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border-radius:14px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);vertical-align:top}
    th{background:#0f1729;color:#9fb0d6;text-align:left;font-size:13px}
    tr:hover td{background:rgba(255,255,255,.03)}
    td.click{cursor:pointer}
    .small{font-size:12px;color:#9fb0d6}
    .pill{display:inline-block;padding:2px 8px;border:1px solid rgba(255,255,255,.14);border-radius:999px;font-size:12px;color:#cfe0ff;margin-right:6px}

    /* overlays */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
    .modal{width:min(720px,100%);background:#121a2c;border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.6);padding:16px}
    .modal h2{margin:0 0 12px;font-size:18px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid .full{grid-column:1/-1}
    textarea{width:100%;min-height:80px;resize:vertical}
    .painRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .painRow label{font-size:13px;color:#9fb0d6}
    .right{margin-left:auto}
    .badge{font-size:12px;color:#9fb0d6}

    /* quick editor */
    .quick{width:min(620px,100%);background:#121a2c;border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.6);padding:16px}
    .quickTitle{display:flex;gap:10px;align-items:center}
    .quickTitle h2{margin:0;font-size:18px}
    .quick textarea{min-height:120px}
    .muted{color:#9fb0d6;font-size:12px}
    .toggle{display:flex;align-items:center;gap:10px}
    .toggle input{width:20px;height:20px}
    .timeRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .timeRow .lbl{width:92px;color:#9fb0d6;font-size:13px}
    .danger{color:#ffb3b3}
  </style>

  <!-- jsPDF + autoTable -->
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <!-- Firebase (modulov√© SDK) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
   import {
  getAuth,
  GoogleAuthProvider,
  signInWithRedirect,
  getRedirectResult,
  onAuthStateChanged,
  signOut,
  signInWithPopup,
  setPersistence,
  browserLocalPersistence
} from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    import {
      getFirestore, doc, getDoc, setDoc, serverTimestamp,
      collection, getDocs, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
    import { getMessaging, getToken, onMessage, isSupported } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-messaging.js";

    // =========================
    // 1) VLO≈Ω SV≈ÆJ FIREBASE CONFIG
    // =========================
const firebaseConfig = {
  apiKey: "AIzaSyB-L0KiCxpjQurF6erkUaGZHLGAcTrISaI",
  authDomain: "jidelnicek-81c42.firebaseapp.com",
  projectId: "jidelnicek-81c42",
  storageBucket: "jidelnicek-81c42.appspot.com",
  messagingSenderId: "295816254355",
  appId: "1:295816254355:web:929a497c6439852e198e66"
};

    // =========================
    // 2) VLO≈Ω SV≈ÆJ VAPID KEY (FCM -> Web Push certificates)
    // Firebase Console ‚Üí Project settings ‚Üí Cloud Messaging ‚Üí Web Push certificates (Public key)
    // =========================
    const VAPID_KEY = "BNr-6MdC1xAbRD_U7RgnKS0Em5WGrx6sbV_G5-bPT9_L7YntQOYfovdzdtIgAJJHbr2nGr9IVJqB5ScNBgY9QoU";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI refs
    const elStatus = document.getElementById("status");
    const elRange = document.getElementById("range");
    const elFrom = document.getElementById("from");
    const elTo = document.getElementById("to");
    const elTableBody = document.getElementById("tbody");
    const elBtnToday = document.getElementById("btnToday");
    const elBtnExportWeek = document.getElementById("btnExportWeek");
    const elBtnExportMonth = document.getElementById("btnExportMonth");
    const elBtnEnableNotif = document.getElementById("btnEnableNotif");
    const elBtnReminders = document.getElementById("btnReminders");
const elBtnLogin = document.getElementById("btnLogin");
const elBtnLogout = document.getElementById("btnLogout");

    const elHintIOS = document.getElementById("hintIOS");

    // Full editor overlay
    const fullBack = document.getElementById("fullBack");
    const fullSave = document.getElementById("fullSave");
    const fullClose = document.getElementById("fullClose");

    const mDate = document.getElementById("mDate");
    const mBreakfast = document.getElementById("mBreakfast");
    const mLunch = document.getElementById("mLunch");
    const mDinner = document.getElementById("mDinner");
    const pBack = document.getElementById("pBack");
    const pNeck = document.getElementById("pNeck");
    const pShoulder = document.getElementById("pShoulder");
    const pNote = document.getElementById("pNote");

    // Quick editor overlay (opened from notification)
    const quickBack = document.getElementById("quickBack");
    const qTitle = document.getElementById("qTitle");
    const qDate = document.getElementById("qDate");
    const qFieldLabel = document.getElementById("qFieldLabel");
    const qText = document.getElementById("qText");
    const qSave = document.getElementById("qSave");
    const qClose = document.getElementById("qClose");
    const qMore = document.getElementById("qMore");
    const qPainWrap = document.getElementById("qPainWrap");
    const qpBack = document.getElementById("qpBack");
    const qpNeck = document.getElementById("qpNeck");
    const qpShoulder = document.getElementById("qpShoulder");
    const qpNote = document.getElementById("qpNote");

    // Reminder overlay
    const remBack = document.getElementById("remBack");
    const remClose = document.getElementById("remClose");
    const remSave = document.getElementById("remSave");
    const remEnabled = document.getElementById("remEnabled");
    const tBreakfast = document.getElementById("tBreakfast");
    const tLunch = document.getElementById("tLunch");
    const tDinner = document.getElementById("tDinner");
    const remMsg = document.getElementById("remMsg");

    let uid = null;
    let cachedDays = []; // {date, breakfast, lunch, dinner, pain}
    let currentQuick = { date: null, meal: null };

    // ---- helpers
    const pad2 = (n)=> String(n).padStart(2,"0");
    function ymd(d){
      const dt = (d instanceof Date) ? d : new Date(d);
      return dt.getFullYear()+"-"+pad2(dt.getMonth()+1)+"-"+pad2(dt.getDate());
    }
    function parseYMD(s){
      const [Y,M,D]=s.split("-").map(Number);
      return new Date(Y, M-1, D);
    }
    function mondayOfWeek(date){
      const d = new Date(date);
      const day = (d.getDay()+6)%7; // Mon=0
      d.setDate(d.getDate()-day);
      d.setHours(0,0,0,0);
      return d;
    }
    function firstDayOfMonth(date){
      return new Date(date.getFullYear(), date.getMonth(), 1);
    }
    function lastDayOfMonth(date){
      return new Date(date.getFullYear(), date.getMonth()+1, 0);
    }
    function setStatus(t){ elStatus.textContent = t; }

    function dateRangeDefault(range){
      const now = new Date();
      if(range==="week"){
        const from = mondayOfWeek(now);
        const to = new Date(from); to.setDate(to.getDate()+6);
        return {from: ymd(from), to: ymd(to)};
      }
      if(range==="month"){
        const from = firstDayOfMonth(now);
        const to = lastDayOfMonth(now);
        return {from: ymd(from), to: ymd(to)};
      }
      return {from: ymd(now), to: ymd(now)};
    }

    function inRange(dateStr, fromStr, toStr){
      return dateStr >= fromStr && dateStr <= toStr;
    }

    function escapeHtml(s){
      return (s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    }

    function minutesToHHMM(minute){
      const hh = Math.floor(minute/60), mm = minute%60;
      return `${pad2(hh)}:${pad2(mm)}`;
    }
    function hhmmToMinutes(hhmm){
      const m = /^(\d{1,2}):(\d{2})$/.exec((hhmm||"").trim());
      if(!m) return null;
      const hh = Number(m[1]), mm = Number(m[2]);
      if(hh<0||hh>23||mm<0||mm>59) return null;
      return hh*60+mm;
    }

    // ---- Firestore paths
    function dayDocRef(dateStr){
      return doc(db, "users", uid, "days", dateStr);
    }
    function tokensColRef(){
      return collection(db, "users", uid, "tokens");
    }
    function notifSettingsRef(){
      return doc(db, "users", uid, "settings", "notifications");
    }

    // ---- load days (simple: load all, then filter)
    async function loadAllDays(){
      setStatus("Naƒç√≠t√°m data‚Ä¶");
      const col = collection(db, "users", uid, "days");
      const qy = query(col, orderBy("date", "desc"));
      const snap = await getDocs(qy);
      cachedDays = [];
      snap.forEach(d=>{
        const data = d.data();
        cachedDays.push({
          date: d.id,
          breakfast: data.breakfast || "",
          lunch: data.lunch || "",
          dinner: data.dinner || "",
          pain: data.pain || {back:0, neck:0, shoulder:0, note:""}
        });
      });
      setStatus("OK");
      renderTable();
    }

    function painPills(pain){
      return `
        <div class="small" style="margin-top:6px">
          <span class="pill">Z√°da ${pain?.back ?? 0}</span>
          <span class="pill">Krk ${pain?.neck ?? 0}</span>
          <span class="pill">Lopatky ${pain?.shoulder ?? 0}</span>
          ${pain?.note ? `<div class="small" style="margin-top:6px">üìù ${escapeHtml(pain.note)}</div>` : ``}
        </div>
      `;
    }

    function renderTable(){
      const fromStr = elFrom.value;
      const toStr = elTo.value;

      const rows = cachedDays
        .filter(r=> inRange(r.date, fromStr, toStr))
        .sort((a,b)=> a.date.localeCompare(b.date)); // asc

      // Ensure every day exists in range (even empty)
      const fromD = parseYMD(fromStr);
      const toD = parseYMD(toStr);
      const full = [];
      for(let d=new Date(fromD); d<=toD; d.setDate(d.getDate()+1)){
        const ds = ymd(d);
        const found = rows.find(x=>x.date===ds);
        full.push(found || {date: ds, breakfast:"", lunch:"", dinner:"", pain:{back:0,neck:0,shoulder:0,note:""}});
      }

      elTableBody.innerHTML = full.map(r=>`
        <tr>
          <td class="click" data-date="${r.date}"><b>${r.date}</b><div class="small">Klikni pro √∫pravy</div></td>
          <td class="click" data-date="${r.date}">${escapeHtml(r.breakfast) || `<span class="small">‚Äî</span>`}${painPills(r.pain)}</td>
          <td class="click" data-date="${r.date}">${escapeHtml(r.lunch) || `<span class="small">‚Äî</span>`}</td>
          <td class="click" data-date="${r.date}">${escapeHtml(r.dinner) || `<span class="small">‚Äî</span>`}</td>
        </tr>
      `).join("");
    }

    function getDayFromCache(dateStr){
      return cachedDays.find(x=>x.date===dateStr) || {date: dateStr, breakfast:"", lunch:"", dinner:"", pain:{back:0,neck:0,shoulder:0,note:""}};
    }

    // ---- Full editor (table click)
    function openFullEditor(dateStr){
      const r = getDayFromCache(dateStr);
      mDate.value = dateStr;
      mBreakfast.value = r.breakfast || "";
      mLunch.value = r.lunch || "";
      mDinner.value = r.dinner || "";
      pBack.value = String(r.pain?.back ?? 0);
      pNeck.value = String(r.pain?.neck ?? 0);
      pShoulder.value = String(r.pain?.shoulder ?? 0);
      pNote.value = r.pain?.note ?? "";
      fullBack.style.display = "flex";
      setTimeout(()=>mBreakfast.focus(),0);
    }

    async function saveFullEditor(){
      const dateStr = mDate.value;
      const payload = {
        date: dateStr,
        breakfast: mBreakfast.value.trim(),
        lunch: mLunch.value.trim(),
        dinner: mDinner.value.trim(),
        pain: {
          back: Number(pBack.value||0),
          neck: Number(pNeck.value||0),
          shoulder: Number(pShoulder.value||0),
          note: pNote.value.trim()
        },
        updatedAt: serverTimestamp()
      };
      await setDoc(dayDocRef(dateStr), payload, {merge:true});
      upsertCache(payload);
      fullBack.style.display = "none";
      renderTable();
    }

    function upsertCache(payload){
      const dateStr = payload.date;
      const idx = cachedDays.findIndex(x=>x.date===dateStr);
      const merged = {
        date: dateStr,
        breakfast: payload.breakfast ?? "",
        lunch: payload.lunch ?? "",
        dinner: payload.dinner ?? "",
        pain: payload.pain ?? {back:0,neck:0,shoulder:0,note:""}
      };
      if(idx>=0) cachedDays[idx] = {...cachedDays[idx], ...merged};
      else cachedDays.push(merged);
    }

    // ---- Quick editor (notification click: only one field)
    function mealTitle(meal){
      if(meal==="breakfast") return "Sn√≠danƒõ";
      if(meal==="lunch") return "Obƒõd";
      if(meal==="dinner") return "Veƒçe≈ôe";
      return "Z√°pis";
    }

    function openQuickEditor(dateStr, meal){
      const r = getDayFromCache(dateStr);
      currentQuick = { date: dateStr, meal };
      qDate.textContent = dateStr;
      qTitle.textContent = `${mealTitle(meal)} ‚Äì rychl√Ω z√°pis`;
      qFieldLabel.textContent = mealTitle(meal);

      // show only one field
      if(meal==="breakfast"){
        qText.value = r.breakfast || "";
        qPainWrap.style.display = "block";
        qpBack.value = String(r.pain?.back ?? 0);
        qpNeck.value = String(r.pain?.neck ?? 0);
        qpShoulder.value = String(r.pain?.shoulder ?? 0);
        qpNote.value = r.pain?.note ?? "";
      } else if(meal==="lunch"){
        qText.value = r.lunch || "";
        qPainWrap.style.display = "none";
      } else if(meal==="dinner"){
        qText.value = r.dinner || "";
        qPainWrap.style.display = "none";
      } else {
        qText.value = "";
        qPainWrap.style.display = "none";
      }

      quickBack.style.display = "flex";
      setTimeout(()=>{
        qText.focus();
        const v = qText.value;
        qText.setSelectionRange(v.length, v.length);
      },0);
    }

    async function saveQuickEditor(){
      const dateStr = currentQuick.date;
      const meal = currentQuick.meal;

      const base = getDayFromCache(dateStr);
      const patch = { date: dateStr, updatedAt: serverTimestamp() };

      if(meal==="breakfast"){
        patch.breakfast = qText.value.trim();
        patch.pain = {
          back: Number(qpBack.value||0),
          neck: Number(qpNeck.value||0),
          shoulder: Number(qpShoulder.value||0),
          note: (qpNote.value||"").trim()
        };
      } else if(meal==="lunch"){
        patch.lunch = qText.value.trim();
      } else if(meal==="dinner"){
        patch.dinner = qText.value.trim();
      }

      await setDoc(dayDocRef(dateStr), patch, {merge:true});

      // update cache: merge with existing
      upsertCache({
        date: dateStr,
        breakfast: patch.breakfast ?? base.breakfast,
        lunch: patch.lunch ?? base.lunch,
        dinner: patch.dinner ?? base.dinner,
        pain: patch.pain ?? base.pain
      });

      quickBack.style.display = "none";
      renderTable();
    }

    // ---- PDF export
    function exportPDF(mode){
      const { jsPDF } = window.jspdf;
      const docPdf = new jsPDF({unit:"pt", format:"a4"});
      const now = new Date();
      const title = (mode==="week") ? "T√Ωdenn√≠ p≈ôehled" : "Mƒõs√≠ƒçn√≠ p≈ôehled";
      const fromStr = elFrom.value;
      const toStr = elTo.value;

      const rows = cachedDays
        .filter(r=> inRange(r.date, fromStr, toStr))
        .sort((a,b)=> a.date.localeCompare(b.date))
        .map(r=> ([
          r.date,
          (r.breakfast||""),
          `Z:${r.pain?.back??0} K:${r.pain?.neck??0} L:${r.pain?.shoulder??0}${r.pain?.note? " | "+r.pain.note:""}`,
          (r.lunch||""),
          (r.dinner||"")
        ]));

      docPdf.setFontSize(14);
      docPdf.text(`${title} (${fromStr} ‚Äì ${toStr})`, 40, 50);
      docPdf.setFontSize(10);
      docPdf.text(`Vygenerov√°no: ${now.toLocaleString("cs-CZ")}`, 40, 70);

      docPdf.autoTable({
        startY: 90,
        head: [["Datum","Sn√≠danƒõ","Bolest","Obƒõd","Veƒçe≈ôe"]],
        body: rows.length ? rows : [["‚Äî","‚Äî","‚Äî","‚Äî","‚Äî"]],
        styles: {fontSize: 9, cellPadding: 4},
        headStyles: {fillColor: [15,23,41]},
        columnStyles: {
          0: {cellWidth: 70},
          1: {cellWidth: 150},
          2: {cellWidth: 120},
          3: {cellWidth: 120},
          4: {cellWidth: 120}
        }
      });

      const filename = (mode==="week") ? `jidelnicek_tyden_${fromStr}_${toStr}.pdf` : `jidelnicek_mesic_${fromStr}_${toStr}.pdf`;
      docPdf.save(filename);
    }

    // ---- Notifications (FCM)
    async function enableNotifications(){
      let supported = false;
      try { supported = await isSupported(); } catch(e){ supported=false; }
      if(!supported){
        alert("Tento prohl√≠≈æeƒç nepodporuje FCM messaging.");
        return;
      }

      const perm = await Notification.requestPermission();
      if(perm !== "granted"){
        alert("Bez povolen√≠ ozn√°men√≠ to nep≈Øjde.");
        return;
      }

      // register SW for FCM
      const reg = await navigator.serviceWorker.register("./firebase-messaging-sw.js");

      const messaging = getMessaging(app);
      const token = await getToken(messaging, { vapidKey: VAPID_KEY, serviceWorkerRegistration: reg });
      if(!token){
        alert("Nepoda≈ôilo se z√≠skat token pro ozn√°men√≠.");
        return;
      }

      // save token (multi-device OK)
      const tokenId = token.slice(0,20);
      await setDoc(doc(tokensColRef(), tokenId), {
        token,
        platform: "web",
        updatedAt: serverTimestamp()
      }, {merge:true});

      alert("Ozn√°men√≠ povolena ‚úÖ");
    }

    async function setupOnMessage(){
      let supported = false;
      try { supported = await isSupported(); } catch(e){ supported=false; }
      if(!supported) return;

      const messaging = getMessaging(app);
      onMessage(messaging, (payload)=>{
        // pokud je appka otev≈ôen√°, udƒõlej quick editor rovnou
        const data = payload?.data || {};
        const dateStr = data.date || ymd(new Date());
        const meal = data.meal || null;
        if(meal) openQuickEditor(dateStr, meal);
      });
    }

    // open from notification click: /?date=YYYY-MM-DD&meal=lunch
    function handleDeepLink(){
      const u = new URL(location.href);
      const dateStr = u.searchParams.get("date");
      const meal = u.searchParams.get("meal");
      if(dateStr && /^\d{4}-\d{2}-\d{2}$/.test(dateStr) && (meal==="breakfast"||meal==="lunch"||meal==="dinner")){
        openQuickEditor(dateStr, meal);
        u.searchParams.delete("date");
        u.searchParams.delete("meal");
        history.replaceState({}, "", u.toString());
      }
    }

    // ---- Reminder settings
    async function openReminders(){
      const snap = await getDoc(notifSettingsRef());
      const data = snap.exists() ? snap.data() : {
        enabled: false,
        tz: "Europe/Prague",
        schedule: [
          { minute: 420, meal: "breakfast" },
          { minute: 720, meal: "lunch" },
          { minute: 1140, meal: "dinner" }
        ]
      };

      const sch = Array.isArray(data.schedule) ? data.schedule : [];
      const get = (meal, def) => (sch.find(x=>x.meal===meal)?.minute ?? def);

      remEnabled.checked = !!data.enabled;
      tBreakfast.value = minutesToHHMM(get("breakfast", 420));
      tLunch.value = minutesToHHMM(get("lunch", 720));
      tDinner.value = minutesToHHMM(get("dinner", 1140));
      remMsg.textContent = "";
      remBack.style.display = "flex";
    }

    async function saveReminders(){
      const a = hhmmToMinutes(tBreakfast.value);
      const b = hhmmToMinutes(tLunch.value);
      const c = hhmmToMinutes(tDinner.value);

      if(a===null||b===null||c===null){
        remMsg.textContent = "Neplatn√Ω ƒças. Pou≈æij HH:MM.";
        return;
      }

      await setDoc(notifSettingsRef(), {
        enabled: !!remEnabled.checked,
        tz: "Europe/Prague",
        schedule: [
          { minute: a, meal: "breakfast" },
          { minute: b, meal: "lunch" },
          { minute: c, meal: "dinner" }
        ],
        updatedAt: serverTimestamp()
      }, {merge:true});

      remBack.style.display = "none";
      alert("Nastaven√≠ p≈ôipom√≠nek ulo≈æeno ‚úÖ");
    }

    // ---- Service worker (offline basic)
    async function registerAppSW(){
      if("serviceWorker" in navigator){
        try{ await navigator.serviceWorker.register("./sw.js"); }catch(e){}
      }
    }

    // ---- events
    elRange.addEventListener("change", ()=>{
      const v = elRange.value;
      const r = dateRangeDefault(v);
      elFrom.value = r.from;
      elTo.value = r.to;
      renderTable();
    });
    elFrom.addEventListener("change", renderTable);
    elTo.addEventListener("change", renderTable);

    elTableBody.addEventListener("click", (e)=>{
      const td = e.target.closest("td");
      if(!td) return;
      const dateStr = td.getAttribute("data-date");
      if(dateStr) openFullEditor(dateStr);
    });

    elBtnToday.addEventListener("click", ()=>{
      const today = ymd(new Date());
      openFullEditor(today);
    });

    fullSave.addEventListener("click", saveFullEditor);
    fullClose.addEventListener("click", ()=> fullBack.style.display="none");
    fullBack.addEventListener("click", (e)=>{ if(e.target===fullBack) fullBack.style.display="none"; });

    qSave.addEventListener("click", saveQuickEditor);
    qClose.addEventListener("click", ()=> quickBack.style.display="none");
    qMore.addEventListener("click", ()=>{
      const d = currentQuick.date || ymd(new Date());
      quickBack.style.display="none";
      openFullEditor(d);
    });
    quickBack.addEventListener("click", (e)=>{ if(e.target===quickBack) quickBack.style.display="none"; });

    elBtnExportWeek.addEventListener("click", ()=> exportPDF("week"));
    elBtnExportMonth.addEventListener("click", ()=> exportPDF("month"));
    elBtnEnableNotif.addEventListener("click", enableNotifications);
    elBtnReminders.addEventListener("click", openReminders);

    remClose.addEventListener("click", ()=> remBack.style.display="none");
    remSave.addEventListener("click", saveReminders);
    remBack.addEventListener("click", (e)=>{ if(e.target===remBack) remBack.style.display="none"; });

// =========================
// Google login (jen tv≈Øj √∫ƒçet)
// =========================
await setPersistence(auth, browserLocalPersistence);

const provider = new GoogleAuthProvider();
provider.setCustomParameters({ prompt: "select_account" });

// 1) Pokud se u≈æivatel pr√°vƒõ vrac√≠ z redirectu, tady se to zpracuje
try {
  const res = await getRedirectResult(auth);
  if(res && res.user){
    console.log("Redirect OK:", res.user.email);
  }
} catch(e){
  console.warn("Redirect error:", e?.code, e?.message);
  alert("P≈ôihl√°≈°en√≠ selhalo: " + (e?.code || e));
}

// Login tlaƒç√≠tko: na PC zkus popup, kdy≈æ to nejde ‚Üí redirect
elBtnLogin.addEventListener("click", async ()=>{
  try{
    await signInWithPopup(auth, provider);
  }catch(e){
    console.warn("Popup failed, falling back to redirect:", e?.code, e?.message);
    await signInWithRedirect(auth, provider);
  }
});

elBtnLogout.addEventListener("click", async ()=>{
  await signOut(auth);
});

setStatus("Nep≈ôihl√°≈°eno ‚Äì klikni P≈ôihl√°sit Google");

onAuthStateChanged(auth, async (u)=>{
  if(!u){
    uid = null;
    setStatus("Nep≈ôihl√°≈°eno ‚Äì klikni P≈ôihl√°sit Google");
    return;
  }

  // pojistka: povol jen konkr√©tn√≠ email
  const email = (u.email || "").toLowerCase();
  if(email !== "jendabernard@gmail.com"){
    alert("Tento √∫ƒçet nem√° p≈ô√≠stup: " + (u.email || ""));
    await signOut(auth);
    return;
  }

  uid = u.uid;
  setStatus("P≈ôihl√°≈°eno ‚Äì naƒç√≠t√°m‚Ä¶");

  await registerAppSW();
  await loadAllDays();
  await setupOnMessage();
  handleDeepLink();

  setStatus("OK");
});
</script>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="row" style="align-items:flex-start">
        <div style="min-width:240px;flex:1 1 auto">
          <h1>J√≠deln√≠ den√≠k</h1>
          <div class="hint">Klikni do tabulky pro pln√© √∫pravy. Notifikace otev≈ôe jen jedno pole (sn√≠danƒõ/obƒõd/veƒçe≈ôe).</div>
          <div id="hintIOS" class="hint" style="display:none;margin-top:6px">
            iOS: push ozn√°men√≠ funguj√≠ spolehlivƒõ jen kdy≈æ je aplikace p≈ôidan√° na plochu (iOS 16.4+).
          </div>
        </div>

        <div class="right" style="display:flex;flex-direction:column;gap:8px;min-width:260px">
          <div class="row" style="justify-content:flex-end">
            <span class="badge" id="status">‚Äî</span>
          </div>
          <div class="row" style="justify-content:flex-end">
            <button id="btnToday" class="primary">+ Zapsat dnes</button>
            <button id="btnEnableNotif" class="primary">Povolit ozn√°men√≠</button>
            <button id="btnLogin" class="primary">P≈ôihl√°sit Google</button>
<button id="btnLogout" class="primary">Odhl√°sit</button>

            <button id="btnReminders" class="primary">P≈ôipom√≠nky</button>
          </div>
        </div>
      </div>

      <div class="spacer"></div>

      <div class="row">
        <label class="hint">Rozsah:</label>
        <select id="range">
          <option value="week" selected>T√Ωden</option>
          <option value="month">Mƒõs√≠c</option>
          <option value="custom">Vlastn√≠</option>
        </select>

        <label class="hint">Od:</label>
        <input id="from" type="date">
        <label class="hint">Do:</label>
        <input id="to" type="date">

        <div class="right"></div>
        <button id="btnExportWeek" class="good">Export t√Ωdne do PDF</button>
        <button id="btnExportMonth" class="good">Export mƒõs√≠ce do PDF</button>
      </div>

      <div class="spacer"></div>

      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th style="width:120px">Datum</th>
              <th>Sn√≠danƒõ + bolest r√°no</th>
              <th>Obƒõd</th>
              <th>Veƒçe≈ôe</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Full editor overlay -->
  <div class="backdrop" id="fullBack">
    <div class="modal">
      <div class="row">
        <h2 style="margin:0">Z√°pis dne (pln√Ω)</h2>
        <div class="right"></div>
        <button id="fullClose">Zav≈ô√≠t</button>
        <button id="fullSave" class="primary">Ulo≈æit</button>
      </div>

      <div class="spacer"></div>

      <div class="grid">
        <div class="full">
          <label class="hint">Datum</label>
          <input id="mDate" type="date">
        </div>

        <div class="full">
          <label class="hint">Sn√≠danƒõ</label>
          <textarea id="mBreakfast" placeholder="Co jsi mƒõl ke sn√≠dani‚Ä¶"></textarea>
        </div>

        <div class="full">
          <label class="hint">Bolest r√°no (0 = nic, 3 = hodnƒõ)</label>
          <div class="painRow">
            <label>Z√°da</label>
            <select id="pBack">
              <option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option>
            </select>

            <label>Krk</label>
            <select id="pNeck">
              <option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option>
            </select>

            <label>Lopatky</label>
            <select id="pShoulder">
              <option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option>
            </select>
          </div>
          <div class="spacer"></div>
          <label class="hint">Pozn√°mka</label>
          <input id="pNote" placeholder="nap≈ô. ztuhlost, bolest hlavy, sp√°nek‚Ä¶">
        </div>

        <div class="full">
          <label class="hint">Obƒõd</label>
          <textarea id="mLunch" placeholder="Co jsi mƒõl k obƒõdu‚Ä¶"></textarea>
        </div>

        <div class="full">
          <label class="hint">Veƒçe≈ôe</label>
          <textarea id="mDinner" placeholder="Co jsi mƒõl k veƒçe≈ôi‚Ä¶"></textarea>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick editor overlay -->
  <div class="backdrop" id="quickBack">
    <div class="quick">
      <div class="quickTitle">
        <h2 id="qTitle">Rychl√Ω z√°pis</h2>
        <div class="right"></div>
        <button id="qClose">Zav≈ô√≠t</button>
        <button id="qSave" class="primary">Ulo≈æit</button>
      </div>
      <div class="spacer"></div>
      <div class="muted">Datum: <b id="qDate"></b></div>
      <div class="spacer"></div>

      <label class="hint" id="qFieldLabel">Pole</label>
      <textarea id="qText" placeholder="Napi≈°, co jsi jedl‚Ä¶"></textarea>

      <!-- pain only for breakfast -->
      <div id="qPainWrap" style="display:none;margin-top:10px">
        <div class="spacer"></div>
        <label class="hint">Bolest r√°no (0 = nic, 3 = hodnƒõ)</label>
        <div class="painRow">
          <label>Z√°da</label>
          <select id="qpBack">
            <option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option>
          </select>

          <label>Krk</label>
          <select id="qpNeck">
            <option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option>
          </select>

          <label>Lopatky</label>
          <select id="qpShoulder">
            <option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option>
          </select>
        </div>
        <div class="spacer"></div>
        <label class="hint">Pozn√°mka</label>
        <input id="qpNote" placeholder="nap≈ô. ztuhlost, bolest hlavy, sp√°nek‚Ä¶">
      </div>

      <div class="spacer"></div>
      <div class="row">
        <span class="muted">Chce≈° doplnit i ostatn√≠ j√≠dla?</span>
        <div class="right"></div>
        <button id="qMore" class="warn">Otev≈ô√≠t pln√Ω z√°pis</button>
      </div>
    </div>
  </div>

  <!-- Reminder overlay -->
  <div class="backdrop" id="remBack">
    <div class="modal" style="width:min(620px,100%)">
      <div class="row">
        <h2 style="margin:0">P≈ôipom√≠nky</h2>
        <div class="right"></div>
        <button id="remClose">Zav≈ô√≠t</button>
        <button id="remSave" class="primary">Ulo≈æit</button>
      </div>

      <div class="spacer"></div>

      <div class="toggle">
        <input type="checkbox" id="remEnabled">
        <label for="remEnabled" class="hint">Zapnuto</label>
      </div>

      <div class="spacer"></div>

      <div class="timeRow">
        <div class="lbl">Sn√≠danƒõ</div>
        <input id="tBreakfast" type="time" value="07:00">
        <span class="muted">‚Üí otev≈ôe jen sn√≠dani (+ bolest)</span>
      </div>
      <div class="spacer"></div>
      <div class="timeRow">
        <div class="lbl">Obƒõd</div>
        <input id="tLunch" type="time" value="12:00">
        <span class="muted">‚Üí otev≈ôe jen obƒõd</span>
      </div>
      <div class="spacer"></div>
      <div class="timeRow">
        <div class="lbl">Veƒçe≈ôe</div>
        <input id="tDinner" type="time" value="19:00">
        <span class="muted">‚Üí otev≈ôe jen veƒçe≈ôi</span>
      </div>

      <div class="spacer"></div>
      <div id="remMsg" class="danger"></div>

      <div class="spacer"></div>
      <div class="hint">
        Pozn.: aby notifikace chodily, mus√≠≈° m√≠t povolen√© ozn√°men√≠ (tlaƒç√≠tko ‚ÄûPovolit ozn√°men√≠‚Äú) a funkci na serveru (Cloud Scheduler).
      </div>
    </div>
  </div>
</body>
</html>
